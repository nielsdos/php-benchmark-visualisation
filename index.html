<!doctype html>
<html>
	<head>
		<title>Performance graphs</title>
		<meta charset="utf-8">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" integrity="sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script>
            window.onload = async _ => {
                const rawData = await fetch('data.json').then(r => r.json());

                const labels = [];

                const data = {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Zend/bench.php',
                            data: [],
                            borderColor: "#7476ad",
                        },
                        {
                            label: 'Symfony Demo',
                            data: [],
                            borderColor: "black",
                        }
                    ]
                };

                // Reformat date
                for (const entry of rawData) {
                    const str = entry.commit_info.date.date.replace(' ', 'T') + entry.commit_info.date.timezone;
                    entry.commit_info.date = new Date(str);
                }

                // Sort by date
                rawData.sort((a, b) => {
                    return a.commit_info.date - b.commit_info.date;
                });

                const summaryToDataSetMapper = {
                    "bench.php": 0,
                    "symfony_demo": 1,
                };

                for (const entry of rawData) {
                    Object.keys(summaryToDataSetMapper).forEach(name => {
                        const id = summaryToDataSetMapper[name];
                        if (entry.summary[name])
                            data.datasets[id].data.push(entry.summary[name].instructions);
                        else
                            data.datasets[id].data.push(null);
                    });
                    labels.push(entry.commit_info.date.toLocaleString());
                }

                const relativeData = {
                    datasets: [
                        JSON.parse(JSON.stringify(data.datasets[0])),
                        JSON.parse(JSON.stringify(data.datasets[1])),
                    ],
                    labels: data.labels,
                };
                for (let i = 0; i < data.datasets.length; ++i) {
                    const dataPoints = relativeData.datasets[i].data;
                    let first = dataPoints[0];
                    for (let j = 1; j < dataPoints.length; ++j) {
                        if (dataPoints[j])
                            dataPoints[j] -= dataPoints[j - 1];
                    }
                    dataPoints[0] = 0;
                    for (let j = 1; j < dataPoints.length; ++j) {
                        if (dataPoints[j])
                            dataPoints[j] = dataPoints[j] * 100 / first;
                    }
                }
                //console.log(relativeData);

                let chart;
                const config = {
                    type: 'line',
                    data,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'PHP performance measurements'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label;

                                        const {commit_info} = rawData[context.dataIndex];
                                        
                                        return [
                                            label + ": " + context.formattedValue,
                                            "",
                                            "Commit ID: " + commit_info.id.substr(0, 8),
                                            commit_info.subject,
                                        ];
                                    }
                                }
                            },
                        },
                        onClick: function(event) {
                            const activePoints = chart.getElementsAtEventForMode(event, 'nearest', {intersect: true}, true);
                            const firstPoint = activePoints[0];
                            if (!firstPoint) return;
                            const label = chart.data.labels[firstPoint.index];
                            const data = rawData[firstPoint.index];
                            const url = "https://github.com/php/php-src/commit/" + data.commit_info.id;
                            window.open(url, "_blank");
                        }
                    },
                };
                chart = new Chart(document.getElementById("chart").getContext("2d"), config);

                let relative = false;

                window.updateChart = () => {
                    relative = !relative;
                    chart.config.data = relative ? relativeData : data;
                    chart.update();
                };
            };
        </script>
        <style>
            body, html {
                margin: 0;
                padding: 0;
            }
            .container {
                margin-top: 16px;
                width: 100%;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            .chart-container {
                width: 90%;
            }
        </style>
	</head>
	<body>
        <div class="container">
            <button onclick="updateChart()">Switch chart type between absolute & relative number of instructions</button>
            <div class="chart-container">
                <canvas id="chart"></canvas>
            </div>
        </div>
	</body>
</html>